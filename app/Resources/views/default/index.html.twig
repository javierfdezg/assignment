{% extends 'base.html.twig' %}

{% block body %}
  <div class="container">
    <div class="row header">
      <div class="col col-sm-2 text-center">
        Post #
      </div>
      <div class="col col-sm-8 text-center">
        <a class="btn btn-default" href="#" role="button">Export</a>
      </div>
      <div class="col col-sm-2 text-center">
        View #
      </div>
    </div>
    <div class="row poster">
      {{ form_start(form) }}
        {{ form_row(form.title) }}
        {{ form_row(form.file) }}
      {{ form_end(form) }}
    </div>
    <div class="row posts" id="post-container">
      
    </div>
{% endblock %}

{% block custom_js %}
    <script src="http://autobahn.s3.amazonaws.com/js/autobahn.min.js"></script>
    <script>
      var conn = new ab.Session('ws://localhost:8080',
        function() {
          conn.subscribe('posts', function(topic, data) {
            if (topic == 'posts') {
              console.log(topic);
            }
          });
          conn.subscribe('views', function(topic, data) {
            if (topic == 'views') {
              console.log(topic);
            }
          });
        },
        function() {
            console.warn('WebSocket connection closed');
        },
        {'skipSubprotocolCheck': true}
      );

      var errorHandler = function(error) {
        console.log(error);
      };

      var completeHandler = function(data) {
        console.log(data);
      };

      $(':file').change(function(){
        var file = this.files[0];
        var name = file.name;
        var size = file.size;
        var type = file.type;
        
        var formData = new FormData($('form')[0]);
        $.ajax({
          url: '/posts', 
          type: 'POST',
          xhr: function() {  
              var myXhr = $.ajaxSettings.xhr();
              return myXhr;
          },
          success: completeHandler,
          error: errorHandler,
          data: formData,
          cache: false,
          contentType: false,
          processData: false
        });
      });


    </script>
  </div>
{% endblock %}
